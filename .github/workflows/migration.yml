name: Database Migration Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      dry_run:
        description: 'Dry run mode (no actual migration)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  validate:
    name: 'Validation & Pre-flight Checks'
    runs-on: ubuntu-latest
    outputs:
      migration-safe: ${{ steps.validate.outputs.safe }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate environment
        id: validate
        run: |
          echo "üîç Running pre-flight validation..."

          # Check if required files exist
          if [ ! -f ".env.mysql" ]; then
            echo "‚ùå Missing .env.mysql file"
            exit 1
          fi

          # Validate Node.js version
          node_version=$(node -v | sed 's/v//')
          if [ "$(printf '%s\n' "$node_version" "18.0.0" | sort -V | head -n1)" != "18.0.0" ]; then
            echo "‚ùå Node.js version must be 18+"
            exit 1
          fi

          # Check database connectivity (if credentials provided)
          if [ -n "$MYSQL_HOST" ]; then
            echo "üîç Testing database connections..."
            # Note: In real CI/CD, you'd use secrets for credentials
          fi

          echo "‚úÖ Pre-flight checks passed"
          echo "safe=true" >> $GITHUB_OUTPUT

  backup:
    name: 'Database Backup'
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.migration-safe == 'true' && inputs.dry_run != true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create backup timestamp
        run: echo "BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV

      - name: Backup current database
        run: |
          echo "üíæ Creating database backup..."
          # In real implementation, this would backup the actual database
          mkdir -p backups
          echo '{"backup": "placeholder", "timestamp": "'$BACKUP_TIMESTAMP'"}' > backups/backup_$BACKUP_TIMESTAMP.json

      - name: Upload backup artifact
        uses: actions/upload-artifact@v6
        with:
          name: database-backup-${{ env.BACKUP_TIMESTAMP }}
          path: backups/

  migrate:
    name: 'Execute Migration'
    runs-on: ubuntu-latest
    needs: [validate, backup]
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure environment
        run: |
          # Copy environment template
          cp .env.mysql.example .env.mysql

          # In real CI/CD, you would inject secrets here
          echo "MYSQL_HOST=${{ secrets.MYSQL_HOST }}" >> .env.mysql
          echo "MYSQL_USER=${{ secrets.MYSQL_USER }}" >> .env.mysql
          echo "MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}" >> .env.mysql
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env.mysql

      - name: Dry run validation
        if: inputs.dry_run == true
        run: |
          echo "üß™ Running dry run validation..."
          node -e "
            console.log('‚úÖ Dry run: Environment configured');
            console.log('‚úÖ Dry run: Dependencies installed');
            console.log('‚úÖ Dry run: Migration script validated');
          "

      - name: Execute migration
        if: inputs.dry_run != true
        run: |
          echo "üöÄ Executing migration for ${{ inputs.environment }}..."

          # Start monitoring in background
          node migration-monitor.js watch &
          MONITOR_PID=$!

          # Execute migration
          if node migrate-data.js; then
            echo "‚úÖ Migration completed successfully"
          else
            echo "‚ùå Migration failed"
            kill $MONITOR_PID
            exit 1
          fi

          # Stop monitoring
          kill $MONITOR_PID

      - name: Generate migration report
        if: always()
        run: |
          echo "üìä Generating migration report..."
          node migration-monitor.js report > migration-report.json

      - name: Upload migration artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: migration-results-${{ github.run_id }}
          path: |
            migration-status.json
            migration-report.json
            logs/

  validate-results:
    name: 'Validate Migration Results'
    runs-on: ubuntu-latest
    needs: migrate
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download migration results
        uses: actions/download-artifact@v4
        with:
          name: migration-results-${{ github.run_id }}

      - name: Validate results
        run: |
          echo "üîç Validating migration results..."

          if [ ! -f "migration-status.json" ]; then
            echo "‚ùå Migration status file not found"
            exit 1
          fi

          # Parse migration status
          status=$(jq -r '.status' migration-status.json)
          error_count=$(jq -r '.errors | length' migration-status.json)

          echo "Migration status: $status"
          echo "Error count: $error_count"

          if [ "$status" != "completed" ]; then
            echo "‚ùå Migration did not complete successfully"
            exit 1
          fi

          if [ "$error_count" -gt 100 ]; then
            echo "‚ö†Ô∏è High error count detected: $error_count"
            # Could send notification here
          fi

          echo "‚úÖ Migration validation passed"

  notify:
    name: 'Send Notifications'
    runs-on: ubuntu-latest
    needs: [validate, backup, migrate, validate-results]
    if: always()
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Send email notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'Migration Pipeline Failed - ${{ inputs.environment }}'
          body: |
            Migration pipeline failed for environment: ${{ inputs.environment }}

            Check the GitHub Actions logs for details:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Triggered by: ${{ github.actor }}
          to: ${{ secrets.ALERT_EMAIL }}
          from: GitHub Actions <noreply@github.com>

  rollback:
    name: 'Rollback (On Failure)'
    runs-on: ubuntu-latest
    needs: migrate
    if: failure() && inputs.dry_run != true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download backup
        uses: actions/download-artifact@v4
        with:
          name: database-backup-${{ env.BACKUP_TIMESTAMP }}

      - name: Execute rollback
        run: |
          echo "üîÑ Executing rollback..."
          # In real implementation, this would restore from backup
          echo "‚úÖ Rollback completed (placeholder)"

      - name: Notify rollback
        uses: 8398a7/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'Migration Rollback Executed - ${{ inputs.environment }}'
          body: |
            Migration rollback has been executed for environment: ${{ inputs.environment }}

            Original migration failed. System has been rolled back to previous state.

            Check the GitHub Actions logs for details:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.ALERT_EMAIL }}
          from: GitHub Actions <noreply@github.com>