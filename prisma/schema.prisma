generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
  NON_BINARY
}

enum Role {
  USER
  ADMIN
  BANNED
}

// Subscription Tiers - "Vriend van de Liefde" Model
enum SubscriptionTier {
  FREE      // Basis - Gratis
  PLUS      // Liefde Plus - ‚Ç¨9,95/maand
  COMPLETE  // Liefde Compleet - ‚Ç¨24,95/3 maanden
}

// Wie zoekt de gebruiker
enum LookingFor {
  MALE
  FEMALE
  BOTH
}

// Onboarding mode - bepaalt hoeveel vragen
enum OnboardingMode {
  SIMPLE    // Minimale vragen (snelle flow)
  STANDARD  // Standaard flow (aanbevolen)
  ADVANCED  // Uitgebreide flow (beste matches)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?
  bio           String?   @db.Text
  birthDate     DateTime?
  gender        Gender?
  city          String?
  postcode      String?
  // Lifestyle fields
  occupation    String?
  education     String?
  height        Int?
  drinking      String?
  smoking       String?
  children      String?
  interests     String?
  preferences   Json?
  profileImage  String?
  voiceIntro    String?
  role          Role      @default(USER)
  isVerified    Boolean   @default(false)
  safetyScore   Int       @default(100)
  hasAcceptedTerms Boolean @default(false)
  latitude      Float?
  longitude     Float?
  twoFactorSecret String?
  twoFactorEnabled Boolean @default(false)
  twoFactorBackupCodes String? @db.Text
  // Real-time presence
  lastSeen      DateTime?
  isOnline      Boolean   @default(false)
  // Photo verification
  isPhotoVerified Boolean @default(false)
  verifiedAt    DateTime?

  // Voice & Liveness verification
  voiceIntroUrl     String?           // URL naar voice intro opname
  isLivenessVerified Boolean @default(false) // Is liveness check voltooid?

  // Subscription & Credits - "Vriend van de Liefde" Model
  subscriptionTier SubscriptionTier @default(FREE)
  credits          Int              @default(0) // Superberichten credits
  monthlySupermessages Int          @default(0) // Maandelijkse gratis superberichten (voor COMPLETE)
  monthlySupermessagesReset DateTime? // Wanneer maandelijkse credits resetten

  // Onboarding & Profile Completion
  lookingFor        LookingFor?                    // Wie zoekt de gebruiker
  minAgePreference  Int              @default(18)  // Minimum leeftijd voorkeur
  maxAgePreference  Int              @default(99)  // Maximum leeftijd voorkeur
  onboardingStep    Int              @default(1)   // Huidige stap in onboarding (1 = eerste stap)
  isOnboarded       Boolean          @default(false) // Is onboarding voltooid?
  onboardingMode    OnboardingMode?                // Gekozen onboarding mode
  profileComplete   Boolean          @default(false) // Is het profiel compleet?
  rulesAccepted     Boolean          @default(false) // Heeft gedragsregels geaccepteerd

  // üåç Passport Mode - Virtual location for swiping in other cities
  passportCity      String?          // Virtual city name
  passportLatitude  Float?           // Virtual latitude
  passportLongitude Float?           // Virtual longitude
  passportExpiresAt DateTime?        // When passport expires

  // üïµÔ∏è Incognito Mode - Browse without appearing in discover
  incognitoMode     Boolean          @default(false)

  // ‚ôø Accessibility Preferences - Vision Impaired Mode
  visionImpairedMode Boolean         @default(false) // Master toggle voor slechtzienden
  extraHighContrast  Boolean         @default(false) // WCAG AAA 7:1 contrast
  textToSpeech       Boolean         @default(false) // Text-to-speech functie
  voiceCommands      Boolean         @default(false) // Voice commands (toekomstig)
  colorBlindMode     String?                         // "none" | "deuteranopia" | "protanopia" | "tritanopia"
  largeTextMode      Boolean         @default(false) // Grote tekst modus
  largeTargetsMode   Boolean         @default(false) // Grote knoppen modus

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]
  photos        Photo[]
  outgoingSwipes Swipe[]  @relation("Swiper")
  incomingSwipes Swipe[]  @relation("Swiped")
  matches1       Match[]  @relation("User1")
  matches2       Match[]  @relation("User2")
  messages       Message[]
  posts          Post[]
  comments       Comment[]
  subscriptions  Subscription[]
  reportsSent    Report[]  @relation("Reporter")
  reportsReceived Report[] @relation("Reported")
  blocksSent     Block[]   @relation("Blocker")
  blocksReceived Block[]   @relation("Blocked")
  notifications  Notification[]
  // AI Matching relations
  matchScoresAsUser    MatchScore[] @relation("MatchScoreUser")
  matchScoresAsTarget  MatchScore[] @relation("MatchScoreTarget")
  embedding            UserEmbedding?
  // Engagement features
  pushSubscriptions    PushSubscription[]
  profileViewsSent     ProfileView[] @relation("ProfileViewer")
  profileViewsReceived ProfileView[] @relation("ProfileViewed")
  profileBoosts        ProfileBoost[]
  profilePrompts       ProfilePrompt[]
  // Superberichten (Love Notes)
  sentSuperMessages     SuperMessage[] @relation("SuperMessageSender")
  receivedSuperMessages SuperMessage[] @relation("SuperMessageReceiver")
  // Veiligheid: Spending Limit
  spendingLimit        SpendingLimit?
  // Credit aankopen historie
  creditPurchases      CreditPurchase[]
  // üì∏ Stories
  stories              Story[]
  storyViews           StoryView[]
  // üõ°Ô∏è Safety & Verification
  photoVerifications   PhotoVerification[]
  // üß† Psychological Profile
  psychProfile         PsychProfile?

  // üéØ Progressive Profiling & Invisible Data Collection
  semanticTags         String[]     // AI-generated tags from behavior ["outdoor-lover", "foodie", "night-owl"]
  promptAnswers        UserPromptAnswer[]
  swipeLogs            SwipeLog[]   // Detailed behavioral data
  requiresLivenessRecheck Boolean   @default(false) // Safety: triggered by suspicious activity

  // Privacy & GDPR Consent
  privacyPolicyAccepted    Boolean   @default(false)
  privacyPolicyVersion     String?   // Welke versie van privacy policy geaccepteerd
  privacyPolicyAcceptedAt  DateTime?
  marketingEmailsConsent   Boolean   @default(false)
  emailPreference          EmailPreference?

  // üåç Passport History & Favorites
  passportHistory          PassportHistory[]
  favoriteCities           FavoriteCity[]

  @@index([gender])
  @@index([birthDate])
  @@index([city])
  @@index([profileImage])
  @@index([createdAt])
  @@index([gender, birthDate, city])
  @@index([role])
  @@index([latitude, longitude])
  @@index([email])
  @@index([isOnline])
  @@index([isPhotoVerified])
  @@index([subscriptionTier])
  @@index([profileComplete])
  @@index([onboardingStep])
  @@index([incognitoMode])
  @@index([passportCity])
}

// ============================================
// üß† PSYCHOLOGICAL PROFILE - For Deep Matching
// ============================================

enum ConflictStyle {
  AVOIDING       // Vermijdt conflicten
  ACCOMMODATING  // Geeft toe aan anderen
  COMPETING      // Wil winnen
  COMPROMISING   // Zoekt middenweg
  COLLABORATING  // Zoekt win-win oplossingen
}

model PsychProfile {
  id              String        @id @default(cuid())
  userId          String        @unique
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Persoonlijkheidsschalen (1-10)
  introvertScale  Int?          // 1 = zeer introvert, 10 = zeer extravert
  emotionalScale  Int?          // 1 = zeer rationeel, 10 = zeer emotioneel
  spontaneityScale Int?         // 1 = plant alles, 10 = zeer spontaan
  adventureScale  Int?          // 1 = houdt van routine, 10 = avontuurlijk

  // Conflicthantering
  conflictStyle   ConflictStyle?

  // Communicatiestijl
  communicationStyle String?    // "direct", "diplomatic", "analytical", "expressive"

  // Waarden & Prioriteiten
  familyImportance Int?         // 1-10: Hoe belangrijk is familie?
  careerImportance Int?         // 1-10: Hoe belangrijk is carri√®re?
  socialImportance Int?         // 1-10: Hoe belangrijk is sociaal leven?

  // Love Language (Chapman's 5 Love Languages)
  loveLangWords     Int?        // Woorden van bevestiging (1-5)
  loveLangTime      Int?        // Quality time (1-5)
  loveLangGifts     Int?        // Cadeaus ontvangen (1-5)
  loveLangActs      Int?        // Behulpzaamheid (1-5)
  loveLangTouch     Int?        // Fysieke aanraking (1-5)

  // Attachment Style
  attachmentStyle   String?     // "secure", "anxious", "avoidant", "fearful"

  // Life Goals
  wantsChildren     String?     // "yes", "no", "maybe", "already_have"
  relationshipGoal  String?     // "casual", "serious", "marriage", "open"

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
}

model Photo {
  id        String   @id @default(cuid())
  url       String
  order     Int      @default(0)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model Swipe {
  id          String   @id @default(cuid())
  swiperId    String
  swiper      User     @relation("Swiper", fields: [swiperId], references: [id], onDelete: Cascade)
  swipedId    String
  swiped      User     @relation("Swiped", fields: [swipedId], references: [id], onDelete: Cascade)
  isLike      Boolean
  isSuperLike Boolean  @default(false)
  createdAt   DateTime @default(now())
  @@unique([swiperId, swipedId])
  @@index([swiperId])
  @@index([swipedId])
  @@index([swipedId, isLike])
  @@index([swiperId, isSuperLike, createdAt])
}

model Match {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  user1Id   String
  user1     User      @relation("User1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2Id   String
  user2     User      @relation("User2", fields: [user2Id], references: [id], onDelete: Cascade)
  messages  Message[]
  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
}

model Message {
  id        String   @id @default(cuid())
  content   String?  @db.Text
  audioUrl  String?
  gifUrl    String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  senderId  String
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  matchId   String
  match     Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([matchId])
  @@index([senderId])
  @@index([createdAt])
  @@index([matchId, createdAt])
  @@index([matchId, read])
}

model Category {
  id          String   @id @default(cuid())
  name        String
  icon        String
  description String?
  color       String
  posts       Post[]
}

model Post {
  id          String    @id @default(cuid())
  title       String
  content     String    @db.Text
  slug        String?   @unique
  excerpt     String?
  featuredImage String?
  published   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  authorId    String
  author      User      @relation(fields: [authorId], references: [id])
  categoryId  String
  category    Category  @relation(fields: [categoryId], references: [id])
  comments    Comment[]
  likeCount   Int       @default(0)

  @@index([authorId])
  @@index([categoryId])
  @@index([published, createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  content   String   @db.Text
  createdAt DateTime @default(now())
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([authorId])
  @@index([postId, createdAt])
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expires])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  @@unique([identifier, token])
}

model Subscription {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  plan            String
  status          String
  multisafepayId  String?
  recurringId     String?   // For recurring payments
  startDate       DateTime  @default(now())
  endDate         DateTime?
  cancelledAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([userId, status])
  @@index([endDate])
}

model Report {
  id          String   @id @default(cuid())
  reporterId  String
  reporter    User     @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedId  String
  reported    User     @relation("Reported", fields: [reportedId], references: [id], onDelete: Cascade)
  reason      String
  description String?
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  resolvedAt  DateTime?
  resolvedBy  String?

  @@index([reporterId])
  @@index([reportedId])
  @@index([status])
  @@index([status, createdAt])
}

model Block {
  id        String   @id @default(cuid())
  blockerId String
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blockedId String
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  title     String
  message   String
  isRead    Boolean  @default(false)
  relatedId String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([userId, isRead])
  @@index([userId, createdAt])
}

model PasswordReset {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model EmailLog {
  id            String    @id @default(cuid())
  userId        String?
  email         String
  type          String
  category      String
  subject       String
  status        String
  sentAt        DateTime  @default(now())
  deliveredAt   DateTime?
  openedAt      DateTime?
  clickedAt     DateTime?
  bouncedAt     DateTime?
  errorMessage  String?
  // A/B Testing
  abTestId      String?
  abTestVariant String?   // 'A' or 'B'
  // Analytics relation
  analytics     EmailAnalytics?

  @@index([userId])
  @@index([email])
  @@index([type, category])
  @@index([sentAt])
  @@index([status])
  @@index([abTestId])
}

// Email analytics tracking
model EmailAnalytics {
  id                String    @id @default(cuid())
  emailLogId        String    @unique
  emailLog          EmailLog  @relation(fields: [emailLogId], references: [id], onDelete: Cascade)

  // Open tracking
  openCount         Int       @default(0)
  firstOpenedAt     DateTime?
  lastOpenedAt      DateTime?

  // Click tracking
  clickCount        Int       @default(0)
  clickedLinks      String[]
  ctaClicked        String?

  // Conversion tracking
  convertedToAction Boolean   @default(false)
  conversionType    String?
  convertedAt       DateTime?
  revenueGenerated  Float?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([emailLogId])
}

// Email A/B Testing
model EmailABTest {
  id                  String    @id @default(cuid())
  name                String
  emailType           String
  variantA            Json
  variantB            Json
  trafficSplitPercent Int       @default(50)
  isActive            Boolean   @default(true)

  // Metrics
  variantASent        Int       @default(0)
  variantBSent        Int       @default(0)
  variantAOpens       Int       @default(0)
  variantBOpens       Int       @default(0)
  variantAClicks      Int       @default(0)
  variantBClicks      Int       @default(0)

  // Results
  winningVariant      String?   // "A" or "B" or null
  confidenceScore     Float?    // 0-100
  endedAt             DateTime?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([emailType, isActive])
  @@index([isActive])
}

// Email Send Time Optimization (ML-based)
model EmailSendTimeOptimization {
  id               String    @id @default(cuid())
  userId           String    @unique

  // Open/click rates by hour (JSON: {"0": 0.5, "1": 0.3, ...})
  openRateByHour   Json      @default("{}")
  clickRateByHour  Json      @default("{}")

  // ML-calculated optimal send time
  optimalSendHour  Int?      // 0-23
  confidenceScore  Float     @default(0)
  dataPoints       Int       @default(0)

  lastCalculatedAt DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([userId])
}

// User email preferences (GDPR compliant)
model EmailPreference {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email category preferences
  dailyDigest       Boolean  @default(true)
  profileNudge      Boolean  @default(true)
  perfectMatch      Boolean  @default(true)
  reEngagement      Boolean  @default(true)
  weeklyHighlights  Boolean  @default(true)
  specialEvents     Boolean  @default(true)
  productUpdates    Boolean  @default(false)

  // Rate limiting
  maxEmailsPerDay   Int      @default(2)
  maxEmailsPerWeek  Int      @default(7)

  // Quiet hours
  quietHoursStart   Int?     // Hour (0-23)
  quietHoursEnd     Int?     // Hour (0-23)

  // Personalization
  preferredSendTime Int?     // Preferred hour to receive emails
  timezone          String   @default("Europe/Amsterdam")

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
}

// ============================================
// AI SMART MATCHING MODELS
// ============================================

model MatchScore {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation("MatchScoreUser", fields: [userId], references: [id], onDelete: Cascade)
  targetUserId  String
  targetUser    User     @relation("MatchScoreTarget", fields: [targetUserId], references: [id], onDelete: Cascade)
  overallScore  Float
  interestScore Float
  bioScore      Float
  locationScore Float
  activityScore Float
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, targetUserId])
  @@index([userId])
  @@index([targetUserId])
  @@index([userId, overallScore])
}

model UserEmbedding {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Bio embedding for semantic matching
  embedding Json     // OpenAI/Claude embedding vector (1536 dimensions)
  bioHash   String?  // Hash to detect bio changes

  // Prompt-enriched embedding (bio + answered prompts)
  enrichedEmbedding Json?  // Combined profile vector
  enrichedAt        DateTime?

  // Semantic tags derived from embeddings
  derivedTags       String[] // AI-generated: ["adventurous", "family-oriented", "creative"]

  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============================================
// ENGAGEMENT & PREMIUM FEATURES
// ============================================

model PushSubscription {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint     String   @unique
  p256dh       String
  auth         String
  userAgent    String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  lastUsedAt   DateTime @default(now())

  @@index([userId])
  @@index([isActive])
}

model ProfileBoost {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  startedAt DateTime @default(now())
  expiresAt DateTime
  isActive  Boolean  @default(true)

  @@index([userId])
  @@index([isActive, expiresAt])
}

model SwipeHistory {
  id        String   @id @default(cuid())
  swipeId   String   @unique
  swiperId  String
  swipedId  String
  isLike    Boolean
  swipedAt  DateTime
  undoneAt  DateTime?
  createdAt DateTime @default(now())

  @@index([swiperId, createdAt])
}

// ============================================
// PRICING & CREDITS SYSTEM - "Vriend van de Liefde"
// ============================================

// Superbericht - Direct contact zonder match (voorheen "Love Notes")
model SuperMessage {
  id        String   @id @default(cuid())
  senderId  String
  sender    User     @relation("SuperMessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  targetId  String
  target    User     @relation("SuperMessageReceiver", fields: [targetId], references: [id], onDelete: Cascade)
  message   String?  @db.Text // Optioneel persoonlijk bericht
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([senderId])
  @@index([targetId])
  @@index([targetId, isRead])
  @@index([createdAt])
}

// Veiligheid: Dagelijkse bestedingslimiet (Circuit Breaker)
// Beschermt gebruikers tegen impulsief koopgedrag
model SpendingLimit {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dailyLimit   Float    @default(20.00) // Max ‚Ç¨20 per dag uitgeven
  currentSpent Float    @default(0.00)  // Vandaag uitgegeven
  lastReset    DateTime @default(now()) // Wanneer currentSpent gereset is

  @@index([lastReset])
}

// Credit aankoop historie
model CreditPurchase {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  credits       Int      // Aantal gekochte credits
  amount        Float    // Betaald bedrag in euros
  paymentId     String?  // MultiSafePay of andere payment provider ID
  paymentMethod String?  // ideal, creditcard, etc.
  status        String   @default("pending") // pending, completed, failed, refunded
  createdAt     DateTime @default(now())
  completedAt   DateTime?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// Subscription Payment - Uitgebreide tracking
model SubscriptionPayment {
  id              String   @id @default(cuid())
  subscriptionId  String
  amount          Float
  currency        String   @default("EUR")
  paymentId       String?  // Payment provider ID
  paymentMethod   String?
  status          String   @default("pending")
  createdAt       DateTime @default(now())
  paidAt          DateTime?

  @@index([subscriptionId])
  @@index([status])
}

// ============================================
// PRIVACY & GDPR COMPLIANCE
// ============================================

// Cookie consent tracking (AVG compliant)
model CookieConsent {
  id              String   @id @default(cuid())
  userId          String?  // Null voor anonieme bezoekers

  // Consent categories
  necessary       Boolean  @default(true)  // Altijd true (functionele cookies)
  analytics       Boolean  @default(false) // Opt-in vereist
  marketing       Boolean  @default(false) // Opt-in vereist

  // Metadata voor compliance
  consentVersion  String   @default("2.0") // Privacy policy versie
  ipAddress       String?
  userAgent       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}

// Consent history (audit trail - AVG vereiste Artikel 7)
model ConsentHistory {
  id              String   @id @default(cuid())
  userId          String?  // Null voor anonieme bezoekers
  consentId       String
  action          String   // 'granted', 'updated', 'revoked'
  categories      Json     // Snapshot van consent state
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([userId, createdAt])
}

// Data export requests (AVG Artikel 20 - Recht op dataportabiliteit)
model DataExportRequest {
  id          String    @id @default(cuid())
  userId      String
  status      String    @default("pending") // pending, processing, completed, failed
  downloadUrl String?   @db.Text // Long URL for secure download
  expiresAt   DateTime? // Download link expires after 7 days
  errorMessage String?  @db.Text
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([userId])
  @@index([status])
  @@index([userId, status])
  @@index([createdAt])
}

// Account deletion requests (AVG Artikel 17 - Recht om vergeten te worden)
model AccountDeletionRequest {
  id              String    @id @default(cuid())
  userId          String    @unique
  reason          String?   @db.Text // Optionele reden voor verwijdering
  scheduledFor    DateTime  // 30 dagen in de toekomst (bedenktijd)
  cancelled       Boolean   @default(false)
  cancelledAt     DateTime?
  processedAt     DateTime? // Wanneer daadwerkelijk verwijderd
  createdAt       DateTime  @default(now())

  @@index([scheduledFor])
  @@index([cancelled])
}

// ============================================
// COUPON SYSTEM - Wereldklasse Marketing Tool
// ============================================

enum CouponType {
  PERCENTAGE    // Percentage korting (bijv. 20% off)
  FIXED_AMOUNT  // Vast bedrag korting (bijv. ‚Ç¨5 off)
  FREE_TRIAL    // Gratis proefperiode (bijv. 1 maand gratis)
}

enum CouponApplicableTo {
  ALL           // Geldt voor alles
  SUBSCRIPTION  // Alleen voor abonnementen
  CREDITS       // Alleen voor credit aankopen
}

model Coupon {
  id                String              @id @default(cuid())
  code              String              @unique // Couponcode (bijv. LOVE2024, NIEUW50)
  description       String?             @db.Text // Interne beschrijving voor admins

  // Discount settings
  type              CouponType
  value             Float               // Percentage (20) of bedrag (5.00)
  applicableTo      CouponApplicableTo  @default(ALL)
  applicablePlans   String?             // JSON array van plannen (bijv. ["PLUS", "COMPLETE"])

  // Restrictions
  minPurchaseAmount Float?              // Minimum aankoopbedrag
  maxDiscountCap    Float?              // Maximum kortingsbedrag (voor percentage coupons)

  // Usage limits
  maxTotalUses      Int?                // Totaal aantal keer te gebruiken (null = onbeperkt)
  maxUsesPerUser    Int                 @default(1) // Max gebruik per gebruiker
  currentTotalUses  Int                 @default(0) // Aantal keer gebruikt

  // Validity period
  validFrom         DateTime            @default(now())
  validUntil        DateTime?           // Null = geen vervaldatum

  // Status
  isActive          Boolean             @default(true)

  // Metadata
  createdBy         String?             // Admin user ID die coupon aanmaakte
  notes             String?             @db.Text // Extra notities voor admins

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  usages            CouponUsage[]

  @@index([code])
  @@index([isActive])
  @@index([validFrom, validUntil])
  @@index([applicableTo])
  @@index([createdAt])
}

// Coupon usage tracking
model CouponUsage {
  id              String   @id @default(cuid())
  couponId        String
  coupon          Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  userId          String

  // Usage details
  orderType       String   // "subscription" of "credits"
  orderId         String?  // Subscription ID of CreditPurchase ID
  discountAmount  Float    // Werkelijke kortingsbedrag toegepast
  originalAmount  Float    // Originele prijs
  finalAmount     Float    // Uiteindelijke prijs na korting

  usedAt          DateTime @default(now())

  @@index([couponId])
  @@index([userId])
  @@index([couponId, userId])
  @@index([usedAt])
}

// ============================================
// PROFILE PROMPTS - Hinge-style Q&A
// ============================================

model ProfilePrompt {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question  String   // De vraag/prompt
  answer    String   @db.Text // Het antwoord van de gebruiker
  order     Int      @default(0) // Volgorde op profiel
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, order])
}

// ============================================
// üì∏ STORIES - 24-hour content like Instagram
// ============================================

enum StoryMediaType {
  PHOTO
  VIDEO
}

model Story {
  id        String         @id @default(cuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  mediaUrl  String         // URL to the media file
  mediaType StoryMediaType @default(PHOTO)
  caption   String?        // Optional caption
  createdAt DateTime       @default(now())
  expiresAt DateTime       // 24 hours after creation
  viewCount Int            @default(0)

  // Views tracking
  views     StoryView[]

  @@index([userId])
  @@index([expiresAt])
  @@index([userId, expiresAt])
  @@index([createdAt])
}

model StoryView {
  id        String   @id @default(cuid())
  storyId   String
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  viewerId  String
  viewer    User     @relation(fields: [viewerId], references: [id], onDelete: Cascade)
  viewedAt  DateTime @default(now())

  @@unique([storyId, viewerId]) // Each user can only view once
  @@index([storyId])
  @@index([viewerId])
}


// Photo Verification for safety - Manual review + AI detection
model PhotoVerification {
  id               String    @id @default(cuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  photoUrl         String    // Selfie URL
  pose             String    @default("neutral") // Pose requested (for AI verification)
  status           String    @default("pending") // pending, approved, rejected, flagged
  submittedAt      DateTime  @default(now())
  reviewedAt       DateTime?
  reviewedBy       String?   // Admin user ID who reviewed
  rejectionReason  String?   @db.Text

  // AI Detection Results
  isAiGenerated    Boolean?  // True if AI thinks photo is AI-generated
  aiConfidence     Float?    // 0.0 - 1.0 confidence score
  aiAnalysis       String?   @db.Text // JSON with detailed analysis
  aiCheckedAt      DateTime? // When AI analysis was performed

  // Additional checks
  hasFace          Boolean?  // Does the photo contain a face?
  faceCount        Int?      // Number of faces detected
  qualityScore     Float?    // 0.0 - 1.0 image quality score

  // Moderator notes
  moderatorNotes   String?   @db.Text // Internal notes for moderators
  priority         Int       @default(0) // Higher = more urgent review (flagged by AI)

  @@index([userId])
  @@index([status])
  @@index([status, submittedAt])
  @@index([priority, submittedAt])
  @@index([isAiGenerated])
}

// Profile views tracking (for "Who viewed me" premium feature)
model ProfileView {
  id        String   @id @default(cuid())
  viewerId  String
  viewer    User     @relation("ProfileViewer", fields: [viewerId], references: [id], onDelete: Cascade)
  viewedId  String
  viewed    User     @relation("ProfileViewed", fields: [viewedId], references: [id], onDelete: Cascade)
  viewedAt  DateTime @default(now())

  @@unique([viewerId, viewedId]) // One view record per viewer-viewed pair
  @@index([viewerId])
  @@index([viewedId])
  @@index([viewedId, viewedAt]) // For "recent viewers"
}

// ============================================
// üéØ PROGRESSIVE PROFILING - "Daily Candy" System
// Invisible data collection through fun daily questions
// ============================================

model DailyPrompt {
  id          String   @id @default(cuid())
  question    String   // "Strand of Bergen?"
  questionNl  String   // Dutch version for LVB users
  emoji       String?  // Visual cue "üèñÔ∏è vs üèîÔ∏è"

  // Answer options as JSON: [{"value": "beach", "label": "Strand", "emoji": "üèñÔ∏è"}, ...]
  options     Json

  // AI/Matching metadata
  vectorTag   String   // Tag applied to user: "beach-lover" or "mountain-person"
  category    String   @default("lifestyle") // lifestyle, social, values, food, hobbies
  weight      Float    @default(1.0) // Importance for matching (1.0 = normal, 2.0 = high priority)

  // Admin controls
  isActive    Boolean  @default(true)
  priority    Int      @default(0) // Higher = shown first to new users

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  answers     UserPromptAnswer[]

  @@index([isActive, priority])
  @@index([category])
}

model UserPromptAnswer {
  id        String      @id @default(cuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  promptId  String
  prompt    DailyPrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)

  // The answer
  answer    String      // Selected option value
  answerLabel String?   // Human-readable answer for display

  // Metadata for AI learning
  responseTimeMs Int?   // How long they took to answer (fast = confident)

  createdAt DateTime    @default(now())

  @@unique([userId, promptId]) // One answer per user per prompt
  @@index([userId])
  @@index([promptId])
  @@index([userId, createdAt]) // For checking "answered in last 24h"
}

// ============================================
// üìä IMPLICIT DATA COLLECTION - Swipe Behavior
// Track HOW users interact, not just WHAT they choose
// ============================================

enum SwipeDirection {
  LEFT      // Rejected
  RIGHT     // Liked
  UP        // Super Like
  TIMEOUT   // Didn't decide (data point!)
}

model SwipeLog {
  id                String         @id @default(cuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetProfileId   String         // Who they were viewing

  // The action
  direction         SwipeDirection

  // Behavioral signals (GOLD for AI matching)
  viewingDurationMs Int            // How long they looked (long = interested even if swiped left)
  photoViewCount    Int            @default(1) // How many photos they viewed
  bioExpanded       Boolean        @default(false) // Did they read full bio?
  scrollDepth       Float?         // 0.0-1.0, how far they scrolled on profile
  voiceIntroPlayed  Boolean        @default(false) // Did they play voice intro?

  // Context
  sessionPosition   Int?           // Nth swipe in this session (fatigue detection)
  timestamp         DateTime       @default(now())

  // Device context
  platform          String?        // "ios", "android", "web"

  @@index([userId])
  @@index([targetProfileId])
  @@index([userId, timestamp])
  @@index([direction])
  @@index([userId, direction]) // For preference analysis
}

// ============================================
// üß† AI PREFERENCE LEARNING - Implicit vs Explicit
// When explicit prefs don't match behavior
// ============================================

model PreferenceDiscrepancy {
  id              String   @id @default(cuid())
  userId          String

  // What they said vs what they do
  explicitPref    String   // "Looking for: age 25-30"
  implicitPref    String   // "Consistently swipes right on: age 35-45"

  // Confidence
  confidence      Float    // 0.0-1.0, how confident we are in the discrepancy
  sampleSize      Int      // Number of data points

  // Action taken
  isApplied       Boolean  @default(false) // Did we update their matching?
  appliedAt       DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([isApplied])
}

// ============================================
// üîê SAFETY SENTINEL - Message Monitoring
// Protect users from scams/abuse
// ============================================

model SafetyFlag {
  id          String   @id @default(cuid())
  userId      String   // The flagged user

  // What triggered it
  triggerType String   // "message_nlp", "behavior_pattern", "report_threshold"
  triggerId   String?  // messageId, etc.

  // Scores
  severity    Float    // 0.0-1.0, how severe
  category    String   // "scam", "harassment", "spam", "underage_risk"

  // Details
  details     Json?    // NLP analysis results, pattern details

  // Resolution
  status      String   @default("pending") // pending, reviewed, actioned, dismissed
  reviewedBy  String?  // Admin ID
  reviewedAt  DateTime?
  actionTaken String?  // "warned", "banned", "liveness_recheck"

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
}

// ============================================
// üåç PASSPORT FEATURE - Travel to other cities
// ============================================

// Track passport usage history (recent locations)
model PassportHistory {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Location data
  city        String
  latitude    Float
  longitude   Float

  // Usage tracking
  usedAt      DateTime @default(now())
  duration    Int      // Hours used

  @@index([userId])
  @@index([userId, usedAt])
}

// User's saved favorite cities for quick access
model FavoriteCity {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Location data
  city        String
  latitude    Float
  longitude   Float

  createdAt   DateTime @default(now())

  @@unique([userId, city])
  @@index([userId])
}

